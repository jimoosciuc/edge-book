# EdgeX Foundry架构总述
EdgeX Foundry作为一个在物理传感和驱动的“真实事物”和IT系统之间服务的边缘中间件平台，其目标就是为快速增长的IoT解决方案提供商快速建立完整的边缘生态系统，从而加快产品上市时间，迅速提升生成规模。
为了达到这样的目标，必定需要考虑各种复杂的应用场景，支持不同的平台，适配各种设备；因此EdgeX Foundry在设计之初便提出了几大指导原则，并依据这些原则设计了其整体架构。

## EdgeX Foundry架构设计的指导原则
为了提供一个供应商无关、灵活、可互操作的边缘网络软件平台，EdgeX Foundry在整体架构设计上遵循7大设计原则。

  * **平台无关**：为了方便各种复杂业务场景的接入，EdgeX Foundry必须与平台无关
    * 硬件（x86、ARM等）
    * 操作系统（Linux、Windows、MacOS等）
    * 分布式系统（允许通过微服务在边缘、网关、雾计算、云计算等平台上分发服务）
    * 部署和编排（Docker、Snaps、K8s、手动部署等）
    * 协议（满足南向和北向的各种协议）
  * **灵活性**：EdgeX Foundry必须非常灵活
    * 平台的任何部分都可以被其他微服务或组件升级、替换或增强
    * 允许业务根据设备能力和用例弹性伸缩
  * **参考实现与最佳实践**：EdgeX Foundry应该提供服务的参考实现方案，但鼓励任何使用方自定义最佳解决方案
  * **存储和分发**：EdgeX Foundry必须提供存储和分发能力
    * 支持边缘系统的断连和远程连接
    * 可处理间歇性连接问题
  * **边缘智能化**：EdgeX Foundry必须支持并促进智能化向边缘发展，以便可以解决如下问题：
    * 驱动延迟问题
    * 带宽和存储问题
    * 远程操作问题
  * **多场景支持**：EdgeX Foundry必须支持Brownfield和Greenfield场景下的设备和传感器的现场部署
  * **安全性**：EdgeX Foundry必须安全且易于管理

## EdgeX Foundry整体架构

EdgeX Foundry是一组开源微服务的集合，这些微服务主要可以分为4个服务层和2个基础增强系统服务；
另外，EdgeX Foundry还提供了两类SDK以便南北方向服务接入集成。其架构图如下图所示：

![EdgeX Foundry整体架构](../.gitbook/assets/edgex-foundry/edgex-foundry-architecture-overview.jpg)

### 核心服务层（Core Services Layer）
核心服务层在EdgeX Foundry中处于南向和北向服务的中间层，其为EdgeX Foundry提供了连接南北向的核心功能。这些核心微服务主要包括：
* 核心数据服务：提供一个持久化存储库和相关的管理服务，用于存储和管理从南向服务中收集的数据。
* 命令服务：用于增强和控制从北向到南向的驱动请求。
* 元数据服务：提供一个存储库和相关的管理服务，专门用于存储和管理连接到EdgeX Foundry的对象。元数据提供了配置新设备并将其与设备服务配对的功能。
* 注册和配置服务：向其他EdgeX Foundry微服务提供有关EdgeX Foundry中的关联服务和微服务配置属性的信息。

### 支持服务层（Supporting Services Layer）
支持服务层位于核心层的上层，主要提供了边缘分析和一些微服务通用治理功能，诸如日志、调度、数据清理、告警等。支持服务层提供的微服务通常都是可选的，也就是说，业务可以根据自身应用场景，灵活选择是否部署这些微服务。支持服务层提供的微服务主要包括：
* 规则引擎服务：边缘分析服务的参考实现方案，其基于EdgeX实例收集的传感器数据在边缘执行if-then条件驱动。
* 调度服务：该服务提供了一个内部EdgeX时钟，调度服务可以通过这个时钟控制执行任何EdgeX服务的操作。在配置指定的时间内，调度服务可以通过REST接口调用任务EdgeX服务的API来触发操作。例如，调度服务会调用核心数据服务的API定期清理已被成功导出的旧数据。
* 告警和通知服务：该服务为EdgeX的服务提供了一个中心化功能来发送告警和通知。其可以将通知发送给另一个系统或运维人员来监控EdgeX实例。
* ~~日志服务~~：其为所有EdgeX服务提供了中央日志记录功能。其他EdgeX服务可以通过REST接口将日志记录发送到日志服务器，日志服务器会将日志持久化的数据库或日志文件中。需要注意的是，由于大多数操作系统和日志工具都能提供比EdgeX日志服务更好的日志聚合能力，所以Geneva版本后，该服务将被删除。这也恰恰说明了EdgeX Foundry在设计时所坚持的原则，只要使用方在对应应用场景有更好的实现方案，EdgeX Foundry提供的服务都可以被最佳方案所替换。

### 应用服务层（Application Service Layer）
应用服务层主要用于提取、处理、转换从EdgeX中获取的观测数据，并将其发送到对应的Endpoint或进程中。当前EdgeX提供了诸多应用服务示例，可将数据发送到主要的云计算提供商（如Amazon IoT Hub、Google IoT Core、Azure IoT Hub、IBM Watson IoT等），MQTT的Topic中以及HTTP Rest接口的端点上。  
应用服务层是基于函数管道的思想进行设计的。在EdgeX中，一个函数管道（functions pipeline）是按指定顺序处理EdgeX事件消息的一组函数的集合。管道中的第一个函数称为触发器（trigger），用于触发整个函数管道的执行。然后，后面的每一个函数都将作用于EdgeX事件消息上；一般地，常用的函数主要包括过滤、转换、压缩和加解密等。当消息通过所有函数处理并被设置为一个接收器后，函数管道执行完成。

    函数管道（Function Pipeline）：管道的概念最初出现在Unix Shell操作中，管道可以把若干个命令串连在一起，且前一个命令的输出作为后一个命令的输入，这样完成一个流式操作。后来，函数式编程范式借鉴了函数管道的思想来实现流式函数调用；其中每一个函数专注于处理一类事务，然后通过管道连接实现复杂的业务功能。

### 设备服务层（Device Services Layer）
设备服务层是一个用于将南向的传感器和设备连接到EdgeX中的边缘连接器，这些南向设备可以涵盖任何行业的任何设备和系统，如家庭或办公楼的供暖和空调系统、灌溉系统、无人机、智能家居等等。设备服务可以同时服务与一个或多个设备，而这些设备不仅可以是单个的物理设备，也可以是网关，设备管理器，设备聚合器以及一组设备的集合。  
设备服务可以通过每个设备原生的协议进行通信；其可以将IoT设备生成和传输的数据转换为EdgeX Foundry通用的数据结构，并将其发送给EdgeX的其他微服务中。  
EdgeX提供了一系列设备服务，这些服务分别使用了许多常见物联网协议，如Modbus、BACnet、BLE等。

### 安全基础设施层（Security Infrastructure）
EdgeX的安全基础设施层提供了对EdgeX Foundry框架所管理的设备、传感器或其他IoT设备的数据和控制的安全防护功能。EdgeX的安全功能同样也是建立在开放接口和可插拔、可替换模块的基础上。EdgeX提供了两个主要的安全组件：
* 安全存储器：用于提供一个安全环境来保存EdgeX的密钥，如数据库的连接密码，连接云服务的令牌等。
* API网关：可用作反向代理，以限制EdgeX REST资源的访问以及进行一些访问控制相关的操作。

### 系统管理层（System Management）
系统管理工具主要为外部管理系统提供了一个中心接入点，可以管理EdgeX服务的生命周期，包括启动、停止和重启等；也可以获取服务的状态、运行状况以及EdgeX服务的相关监控指标等。

### SDK（Software Development Kits）
EdgeX提供了两种类型的SDK用于帮助快速创建南北向服务，特别是创建应用服务和设备服务。通过提供包含服务基本操作的脚手架代码，开发人员可以忽略EdgeX的实现细节而专注于自身的南北向业务连接实现细节，从而更快速、更便捷的接入EdgeX Foundry框架中。
